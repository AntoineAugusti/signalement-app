<app-breadcrumb [step]="step" [report]="report"></app-breadcrumb>
<section class="section section-white">
  <div class="container">

    <form [formGroup]="detailsForm" (submit)="submitDetailsForm()" id="detailsForm" *ngIf="detailsForm">

      <div class="notification success" *ngIf="report.subcategories">
        <h4>{{getSubcategoryTitles()}}</h4>
      </div>

      <div *ngIf="getReportLastSubcategory()?.description" class="row notification note">
        <div class="text-right">
          <img alt="Icône information" src="/assets/images/icon_info.png">
        </div>
        <div class="text-left">
          <app-collapsable-text [content]="getReportLastSubcategory().description" [title]="getReportLastSubcategory().title"></app-collapsable-text>
        </div>
      </div>

      <ng-container *ngIf="this.getReportLastSubcategory()?.detailInputs; else noDetailsInput">
        <div class="form__group" *ngFor="let detailInput of this.getReportLastSubcategory().detailInputs">
          <label [for]="getFormControlId(detailInput)">
            {{detailInput.label}}
          </label>

          <div class="row" *ngIf="detailInput.type === 'TEXT'">
            <div class="col-12">
              <input type="text"
                     [formControlName]="getFormControlName(detailInput)"
                     [placeholder]="detailInput.placeholder"
                     [id]="getFormControlId(detailInput)">
            </div>
          </div>

          <div class="row" *ngIf="detailInput.type === 'DATE'">
            <div class="col-12 col-sm-6">
              <input type="text"
                     [formControlName]="getFormControlName(detailInput)"
                     [placeholder]="detailInput.placeholder"
                     [id]="getFormControlId(detailInput)"
                     bsDatepicker
                     [bsConfig]="{ containerClass: 'theme-default' }">
            </div>
          </div>

          <ng-container *ngIf="detailInput.type === 'RADIO'">
            <div class="row pb-2 pl-3" *ngFor="let option of detailInput.options">
              <div class="col-2 col-sm-1 text-right pr-1">
                <input type="radio"
                       [formControlName]="getFormControlName(detailInput)"
                       [value]="option"
                       [id]="getFormControlId(detailInput, option)"
                       (change)="initRadioPrecision(detailInput, option)"/>
              </div>
              <div class="col-10 col-sm-11 pl-1">
                <label class="d-block mb-0 pointer" [for]="getFormControlId(detailInput, option)">{{option}}</label>
                <div class="row" *ngIf="isRadioPrecisionRequired(detailInput, option)">
                  <div class="col-12">
                    <input type="text" [formControlName]="getFormControlName(detailInput, option)" [id]="getFormControlId(detailInput, option, true)" placeholder="Précisez ...">
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-container *ngIf="detailInput.type === 'TEXTAREA'">
            <textarea [formControlName]="getFormControlName(detailInput)"
                      [id]="getFormControlId(detailInput)"
                      (blur)="searchKeywords(getFormControl(detailInput))"
                      rows="3"
                      maxlength="500"
                      placeholder="500 caractères maximum">
            </textarea>
            <br />
            <div class="notification warning" [@openClose]="keywordsDetected ? 'open' : 'closed'">
              <span>{{ keywordsDetected?.message }}</span>
              <span *ngIf="keywordsDetected" class="link link-keyword" (click)="goToInformationPage()">Continuez ici</span>
            </div>
          </ng-container>

        </div>
        <div class="form__group" *ngIf="this.getReportLastSubcategory()?.fileLabel">
          <label>
            <img alt="Icône du bouton joindre" src="/assets/images/icon_attachment.png">
            {{this.getReportLastSubcategory().fileLabel}}
          </label>
          <div class="row text-center">
            <div class="col-12 offset-md-6 col-md-6">
              <table class="table table-sm">
                <tbody>
                <tr *ngFor="let uploadedFile of uploadedFiles">
                  <td class="text-left" style="position: relative" *ngIf="uploadedFile.loading" colspan="2">
                    {{uploadedFile.displayedFilename}}
                    <ngx-loading [show]="uploadedFile.loading" [config]="{backdropBackgroundColour: 'rgba(0, 0, 0, 0.05)'}"></ngx-loading>
                  </td>
                  <td class="text-left" *ngIf="!uploadedFile.loading">
                    <a href="{{getFileDownloadUrl(uploadedFile)}}">
                        <span [class]="uploadedFile.id ? '' : 'error'">
                          {{uploadedFile.displayedFilename}}
                        </span>
                    </a>
                  </td>
                  <td class="text-right pointer" *ngIf="!uploadedFile.loading">
                    <img alt="Icône du bouton suivant" src="/assets/images/icon_remove.png" (click)="removeUploaderFile(uploadedFile)">
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="notification error" *ngIf="tooLargeFilename">
            Le fichier <i>"{{tooLargeFilename}}"</i> est trop volumineux, veuillez choisir un fichier de moins de 5Mo.
          </div>
          <div class="row pb-3">
            <div class="col-12 text-center">
              <input type="file" #fileInput class="form-control-file" hidden (change)="selectFile()">
              <button type="button" class="btn btn-outline-primary"(click)="bringFileSelector()">
                Ajouter
              </button>
            </div>
          </div>
          <div class="note">
            Un signalement avec des pièces jointes (ticket de caisse, photo, vidéo...) a 83% de chance en plus d'entrainer une mesure corrective de la part du professionnel.
          </div>
        </div>
        <div class="notification error" *ngIf="showErrors && detailsForm.invalid">
          Veuillez renseigner tous les champs.<br />
        </div>
      </ng-container>

      <ng-template #noDetailsInput>
        <div class="form__group" *ngIf="getReportLastSubcategory()?.details?.precision; let precision">
          <label>
            {{precision.title}}
          </label>
          <ng-container *ngIf="detailsForm.controls.multiplePrecision">
            <div class="row pb-2 pl-3" *ngFor="let precisionControl of detailsForm.controls.multiplePrecision.controls; let i = index">
              <div class="col-2 col-sm-1 text-right pr-1">
                <input type="checkbox" [formControl]="precisionControl" id="checkbox-{{precision.options[i].title}}" (change)="initOtherPrecision()"/>
              </div>
              <div class="col-10 col-sm-11 pl-1">
                <label class="d-block mb-0 pointer" for="checkbox-{{precision.options[i].title}}">{{precision.options[i].title}}</label>
                <app-collapsable-text [content]="precision.options[i].content" [title]="precision.options[i].title"></app-collapsable-text>
              </div>
            </div>
          </ng-container>
          <ng-container *ngIf="detailsForm.controls.singlePrecision">
            <div class="row pb-2 pl-3" *ngFor="let option of precision.options">
              <div class="col-2 col-sm-1 text-right pr-1">
                <input type="radio" formControlName="singlePrecision" [value]="option.title" id="radio-{{option.title}}" (change)="initOtherPrecision()"/>
              </div>
              <div class="col-10 col-sm-11 pl-1">
                <label class="d-block mb-0 pointer" for="radio-{{option.title}}">{{option.title}}</label>
                <app-collapsable-text [content]="option.content" [title]="option.title"></app-collapsable-text>
              </div>
            </div>
          </ng-container>
          <div class="row" *ngIf="detailsForm.contains('otherPrecision')">
            <div class="offset-2 offset-sm-1 col-10 col-sm-11">
                <input type="text" formControlName="otherPrecision" placeholder="Précisez ...">
            </div>
          </div>
        </div>

        <div class="form__group">
          <label>
            Description du problème
          </label>
          <br />
          <span class="note" [innerHTML]="getReportLastSubcategory()?.details?.descriptionTips" *ngIf="getReportLastSubcategory()?.details?.descriptionTips"></span>
          <textarea formControlName="description"
                    rows="3"
                    maxlength="500"
                    placeholder="500 caractères maximum"
                    (blur)="searchKeywords()">
          </textarea>
          <br />
          <div class="notification warning" [@openClose]="keywordsDetected ? 'open' : 'closed'">
              <span>{{ keywordsDetected?.message }}</span>
              <span *ngIf="keywordsDetected" class="link link-keyword" (click)="goToInformationPage()">Continuez ici</span>
          </div>

        </div>

        <div class="form__group">
          <label>
            Date et plage horaire du constat
          </label>
          <div class="row">
            <div class="col-12 col-sm-6">
              <input type="text"
                     formControlName="anomalyDate"
                     placeholder="Date du constat"
                     bsDatepicker
                     [bsConfig]="{ containerClass: 'theme-default' }">
            </div>
            <div class="col-12 col-sm-6">
              <div class="form__group">
                <select formControlName="anomalyTimeSlot" [class]="anomalyTimeSlotCtrl.value ? 'selected' : ''">
                  <option disabled value="">Plage horaire</option>
                  <option *ngFor="let hour of plageHoraireList" value="{{hour}}">de {{hour}}h à {{hour + 1}}h</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <hr />
        <div class="form__group">
          <label>
            <img alt="Icône du bouton joindre" src="/assets/images/icon_attachment.png">
            Pièces jointes
          </label>
          <div class="row text-center">
            <div class="col-12 offset-md-6 col-md-6">
              <table class="table table-sm">
                <tbody>
                  <tr *ngFor="let uploadedFile of uploadedFiles">
                    <td class="text-left" style="position: relative" *ngIf="uploadedFile.loading" colspan="2">
                      {{uploadedFile.displayedFilename}}
                      <ngx-loading [show]="uploadedFile.loading" [config]="{backdropBackgroundColour: 'rgba(0, 0, 0, 0.05)'}"></ngx-loading>
                    </td>
                    <td class="text-left" *ngIf="!uploadedFile.loading">
                      <a href="{{getFileDownloadUrl(uploadedFile)}}">
                        <span [class]="uploadedFile.id ? '' : 'error'">
                          {{uploadedFile.displayedFilename}}
                        </span>
                      </a>
                    </td>
                    <td class="text-right pointer" *ngIf="!uploadedFile.loading">
                      <img alt="Icône du bouton suivant" src="/assets/images/icon_remove.png" (click)="removeUploaderFile(uploadedFile)">
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="notification error" *ngIf="tooLargeFilename">
            Le fichier <i>"{{tooLargeFilename}}"</i> est trop volumineux, veuillez choisir un fichier de moins de 5Mo.
          </div>
          <div class="row pb-3">
            <div class="col-12 text-center">
              <input type="file" #fileInput class="form-control-file" hidden (change)="selectFile()">
              <button type="button" class="btn btn-outline-primary"(click)="bringFileSelector()">
                Ajouter une pièce jointe
              </button>
            </div>
          </div>
          <div class="note">
            Un signalement avec des pièces jointes (ticket de caisse, photo, vidéo...) a 83% de chance en plus d'entrainer une mesure corrective de la part du professionnel.
          </div>
        </div>
        <div class="notification error" *ngIf="showErrors && detailsForm.invalid">
          <span *ngIf="anomalyDateCtrl.hasError('required')">
            Veuillez renseigner la date du constat.<br />
          </span>
          <span *ngIf="singlePrecisionCtrl && singlePrecisionCtrl.hasError('required')">
            Veuillez préciser.
          </span>
        </div>
      </ng-template>
      <hr />
      <button type="submit" class="btn btn-lg btn-primary" [disabled]="isUploadingFile()">
        <img alt="Icône du bouton suivant" src="/assets/images/icon_play.png">
        Identifier le commerçant
      </button>
    </form>
  </div>
</section>
