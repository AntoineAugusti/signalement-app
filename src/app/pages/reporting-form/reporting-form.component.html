<div class="banner" role="banner">
  <div class="banner_container">
    <h2 class="text-center">
      Absence de prix, manque d'hygiène, garantie non respectée ou victime d'une fraude&#160;...&#160;?
      <br />
      <br class="d-sm-none" />
      Signalez votre problème facilement aux services compétents et aux professionnels.
    </h2>
    <h3>
      Magasins, commerces de proximité, cafés et restaurants...
    </h3>
    <div class="text-center">
      <a href="#reportingForm" (click)="initReportingForm(true)" class="button large">
        <img src="/assets/images/icon_play.png" alt="Icône du bouton de signalement"/> Je signale en 30 secondes
      </a>
    </div>
  </div>
</div>

<main role="main">

  <section class="section section-white">
    <div class="container">
      <div class="row">
        <div class="col-12 mb-3 col-sm-4">
          <div class="icon">
            <img src="/assets/images/icon_store.png" alt="Icône magasin"/>
          </div>
          <p class="text-center"><b>Simple et rapide</b></p>
          <p>
            Cette plateforme permet aux consommateurs de signaler facilement et rapidement les anomalies
            qu'ils rencontrent dans leur vie de tous les jours.
          </p>
        </div>
        <div class="col-12 mb-3 col-sm-4">
          <div class="icon">
            <img src="/assets/images/icon_workflow.png" alt="Icône workflow"/>
          </div>
          <p class="text-center"><b>Au service des professionnels</b></p>
          <p>
            Les signalements sont centralisés et transmis aux professionnels concernés pour qu'ils puissent
            corriger les problèmes.
          </p>
        </div>
        <div class="col-12 col-sm-4">
          <div class="icon">
            <img src="/assets/images/icon_alarm.png" alt="Icône alarme"/>
          </div>
          <p class="text-center"><b>Collaboratif et citoyen</b></p>
          <p>
            Vous êtes plusieurs à signaler les mêmes anomalies et la situation perdure ?
            Les enquêteurs de la répression des fraudes seront avertis.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section class="section-small section-primary">
    <div class="container">
      <div class="row">
        <div class="col-12 col-sm-1 icon">
          <img src="/assets/images/icon_caution.png" alt="Icône attention"/>
        </div>
        <div class="col-12 col-sm-11">
          <h5>
            Attention, un signalement ne constitue pas une saisine formelle de la DGCCRF au sens de
            l’article L. 112-8 du code des relations entre le public et l’administration.
            Notre plateforme ne propose pas de suivi personnalisé de votre dossier.
          </h5>
        </div>
      </div>
    </div>
  </section>

  <section class="section section-gray position-relative">
    <div class="container">
      <form [formGroup]="reportingForm" (submit)="createReporting()" *ngIf="!showSuccess" id="reportingForm">
        <h1 class="text-center">Signalez une anomalie</h1>
        <div class="panel">
          <div class="form__group">
            <label>
              Sélectionnez d'abord le type d'établissement que vous souhaitez signaler <span>*</span>
            </label>
            <select formControlName="companyType"
                    (change)="changeCompanyType()">
              <option disabled value="">Choisissez ...</option>
              <option *ngFor="let anomaly of anomalies" value="{{anomaly.companyType}}">{{anomaly.companyType}}</option>
              <option value="Autres">Autres ...</option>
            </select>
            <div class="invalid" *ngIf="showErrors && companyTypeCtrl.hasError('required')">
              Veuillez compléter le champ "Type d'établissement".
            </div>
          </div>

          <div class="form__group" *ngIf="reportingForm.controls['anomalyCategory']">
            <label>
              Puis, indiquez le type d'anomalie que vous avez constaté <span>*</span>
            </label>
            <select formControlName="anomalyCategory"
                    (change)="changeAnomalyCategory()">
              <option disabled value="">Choisissez ...</option>
              <option *ngFor="let anomalyType of anomalyTypeList" value="{{anomalyType.category}}">{{anomalyType.category}}</option>
            </select>
            <div class="invalid" *ngIf="showErrors && anomalyCategoryCtrl.hasError('required')">
              Veuillez compléter le champ "Type d'anomalie".
            </div>
          </div>

          <div class="form__group" *ngIf="reportingForm.controls['anomalyPrecision']">
            <label>
              Précisez enfin l'anomalie <span>*</span>
            </label>
            <select formControlName="anomalyPrecision"
                    (change)="changeAnomalyPrecision()">
              <option disabled value="">Choisissez ...</option>
              <option *ngFor="let anomalyPrecision of anomalyPrecisionList" value="{{anomalyPrecision}}">{{anomalyPrecision}}</option>
            </select>
            <div class="invalid" *ngIf="showErrors && anomalyPrecisionCtrl.hasError('required')">
              Veuillez compléter le champ "Anomalie".
            </div>
          </div>
        </div>

        <div class="notification success" *ngIf="anomalyInfo; else realAnomaly">
          <img src="/assets/images/icon_info.png" class="d-none d-sm-inline-block" *ngIf="anomalyInfo.title"/>
          <h5 [innerHTML]="anomalyInfo.title"></h5>
          <div [innerHTML]="anomalyInfo.info"></div>
        </div>

        <ng-template #realAnomaly>
          <div class="panel">

            <div *ngIf="companyCtrl.value; else searchCompany">
              Etablissement
              <div class="company panel pt-3 mb-3">
                <span *ngIf="companyCtrl.value.line1">{{companyCtrl.value.line1}}<br /></span>
                <span *ngIf="companyCtrl.value.line2">{{companyCtrl.value.line2}}<br /></span>
                <span *ngIf="companyCtrl.value.line3">{{companyCtrl.value.line3}}<br /></span>
                <span *ngIf="companyCtrl.value.line4">{{companyCtrl.value.line4}}<br /></span>
                <span *ngIf="companyCtrl.value.line5">{{companyCtrl.value.line5}}<br /></span>
                <span *ngIf="companyCtrl.value.line6">{{companyCtrl.value.line6}}<br /></span>
                <span *ngIf="companyCtrl.value.line7">{{companyCtrl.value.line7}}<br /></span>
                <div class="text-center text-sm-right">
                  <span (click)="changeCompany()" class="link">Changer d'établissement</span>
                </div>
              </div>
            </div>

            <ng-template #searchCompany>
              <app-company-form (companySelected)="onCompanySelected($event)"></app-company-form>
            </ng-template>

            <div class="invalid" *ngIf="showErrors && companyCtrl.hasError('required')">
              Veuillez identifier l'établissement.
            </div>

          </div>

          <div class="panel">

            <div class="form__group">
              <label>
                Veuillez préciser la date <span>*</span> et la plage horaire du constat
              </label>
              <div class="row">
                <div class="col-12 col-sm-6">
                  <input type="text"
                         formControlName="anomalyDate"
                         placeholder="Date du constat"
                         bsDatepicker
                         [bsConfig]="{ containerClass: 'theme-default' }">
                  <div class="invalid" *ngIf="showErrors && anomalyDateCtrl.hasError('required')">
                    Veuillez compléter le champ "Date du constat".
                  </div>
                </div>
                <div class="col-12 col-sm-6">
                  <div class="form__group">
                    <select formControlName="anomalyTimeSlot">
                      <option disabled value="">Plage horaire</option>
                      <option *ngFor="let hour of plageHoraireList" value="{{hour}}">de {{hour}}h à {{hour + 1}}h</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="form__group">
              <label>
                Vous pouvez également ajouter des photos
              </label>
              <app-file-input
                [placeholder]="'Photo du ticket de caisse'"
                (fileSelected)="onTicketFileSelected($event)">
              </app-file-input>
              <app-file-input
                [placeholder]="'Photo du problème'"
                (fileSelected)="onAnomalyFileSelected($event)">
              </app-file-input>
            </div>

            <div class="form__group">
              <label>
                Vous pouvez préciser votre signalement
              </label>
              <textarea formControlName="description"
                        rows="3"
                        maxlength="200"
                        placeholder="200 caractères maximum">
              </textarea>
            </div>

          </div>

          <div class="panel">
            <p class="font-weight-bold">
              Merci de compléter votre identité afin d'authentifier votre signalement.
              <br/>
              Votre identité ne sera pas indiquée au professionnel et vous ne serez pas sollicité.
            </p>

            <div class="form__group">
              <div class="row">
                <div class="col-12 col-sm-6">
                  <label>
                    Votre prénom <span>*</span>
                  </label>
                  <input type="text" formControlName="firstName" name="fname" autocomplete="given-name">
                  <div class="invalid" *ngIf="showErrors && firstNameCtrl.hasError('required')">
                    Veuillez compléter le champ "Prénom".
                  </div>
                </div>

                <div class="col-12 col-sm-6">
                  <label>
                    Votre nom <span>*</span>
                  </label>
                  <input type="text" formControlName="lastName" name="lname" autocomplete="family-name">
                  <div class="invalid" *ngIf="showErrors && lastNameCtrl.hasError('required')">
                    Veuillez compléter le champ "Nom".
                  </div>
                </div>
              </div>
            </div>

            <div class="form__group">
              <label>
                Votre email <span>*</span>
              </label>
              <input type="email" formControlName="email" name="email" autocomplete="email">
              <div class="invalid" *ngIf="showErrors && emailCtrl.hasError('required')">
                Veuillez compléter le champ "Email".
              </div>
              <div class="invalid" *ngIf="showErrors && emailCtrl.hasError('email')">
                Veuillez renseigner une adresse email valide pour le champ "E-mail".
              </div>
            </div>

            <div class="form__group">
              <input formControlName="contactAgreement" type="checkbox" value="" id="anonymousCheck">
              <label for="anonymousCheck" class="label-inline">
                Je souhaite que mes coordonnées soient transmises au professionnel afin qu'il puisse me contacter.
              </label>
            </div>
          </div>

          <ng-container>


            <div class="notification error" *ngIf="showErrors && reportingForm.invalid">
              Un ou plusieurs champs sont invalides.
              <br />
              Merci de corriger les erreurs puis de valider de nouveau le formulaire.
            </div>

            <button type="submit" class="btn btn-primary btn-lg btn-block" *ngIf="isIntoxicationAlimentaire(); else mainButton">
              Suivant
            </button>
            <ng-template #mainButton>
              <button type="submit" class="btn btn-primary btn-lg btn-block">
                Signaler
              </button>
            </ng-template>
          </ng-container>
        </ng-template>

      </form>

      <div *ngIf="showSuccess" class="col-sm-12 offset-lg-2 col-lg-8">
        <ng-container *ngIf="isIntoxicationAlimentaire(); else thanks">
          <h3>Les intoxications alimentaires ne rentrent pas dans le périmètre de l'outil signalement.</h3>
          <p>
            Les cas d'intoxication alimentaire nécessitent une analyse individualisée
            (notamment le nombre de personnes malades, symptômes et aliments suspectés )
            et peuvent déboucher sur un échange avec les enquêteurs.
            Veuillez remplir le formulaire "Courrier" de la DGCCRF en cliquant sur le lien ci-contre :
            <a href="https://www.economie.gouv.fr/courrier/4210">https://www.economie.gouv.fr/courrier/4210</a>
          </p>
        </ng-container>
        <ng-template #thanks>
          <h2>Merci pour votre signalement</h2>
          <p class="mt-4">
            Afin de corriger lui-même l’anomalie, le professionnel pourra aussi consulter votre signalement anonymisé.
            <br />
            Il ne déclenchera pas à lui seul un contrôle des autorités.
          </p>
          <div class="text-center pt-4">
            <a href="#reportingForm" (click)="addNewReporting()" class="btn button large">
              <img src="/assets/images/icon_play.png" alt="Icône du bouton de signalement"/> Faire un autre signalement
            </a>
          </div>
        </ng-template>
      </div>
    </div>

    <ngx-loading [show]="loading"></ngx-loading>

  </section>

</main>

